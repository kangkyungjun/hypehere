{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "내 프로필 - HypeHere" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/post_grid.css' %}">
<link rel="stylesheet" href="{% static 'css/post_view_modal.css' %}">
<style>
  /* 프로필 페이지 전용: 좌우 여백 6px */
  .main-content {
    padding-left: 0.375rem !important;   /* 6px */
    padding-right: 0.375rem !important;  /* 6px */
  }

  /* Stat link styling */
  .stat-link {
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    border-radius: var(--radius-sm);
    padding: var(--space-xs);
    margin: calc(-1 * var(--space-xs));
  }

  .stat-link:hover {
    background-color: var(--color-hover);
    transform: translateY(-2px);
  }
</style>
{% endblock %}

{% block content %}
{% if deactivated %}
<div class="container" style="max-width: 600px; margin-top: var(--space-xl); text-align: center;">
    <div class="card">
        <div class="card-body" style="padding: var(--space-xxl);">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto var(--space-lg); color: var(--color-text-light);">
                <circle cx="12" cy="12" r="10"/>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
            </svg>
            <h1 style="font-size: 1.5rem; margin-bottom: var(--space-md);">@{{ profile_user.username }}</h1>
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">비활성화된 계정입니다</p>
            <a href="/" class="btn btn-primary">홈으로 돌아가기</a>
        </div>
    </div>
</div>
{% else %}
<div class="container" style="max-width: 800px; margin-top: var(--space-xl);">
    <div class="card mb-lg">
        <div class="card-body">
            <div class="flex items-center gap-lg mb-lg">
                <div class="avatar avatar-xl" id="profile-avatar"
                     {% if is_own_profile %}style="cursor: pointer; position: relative;" title="클릭하여 프로필 사진 변경"{% else %}style="position: relative;"{% endif %}>
                    {% if profile_user.profile_picture %}
                        <img src="{{ profile_user.profile_picture.url }}" alt="{{ profile_user.username }}" id="avatar-img">
                    {% else %}
                        <svg viewBox="0 0 100 100" fill="currentColor" style="color: var(--color-primary);" id="avatar-svg">
                            <circle cx="50" cy="35" r="20"/>
                            <path d="M15 85 Q15 55 50 55 Q85 55 85 85 Z"/>
                        </svg>
                    {% endif %}
                    <div id="avatar-loading" class="hidden" style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); border-radius:50%; align-items:center; justify-content:center;">
                        <span class="spinner spinner-primary"></span>
                    </div>
                </div>
                <input type="file" id="profile-picture-input" accept="image/*" class="hidden">
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-xs" style="width: 100%;">
                        <h1 class="mb-0" style="flex: 0 0 auto;">{{ profile_user.username }}</h1>
                        {% if is_own_profile %}
                        <a href="{% url 'accounts:update' %}"
                           class="btn btn-ghost btn-sm"
                           style="padding: 0.25rem 0.5rem; font-size: 0.875rem; min-height: auto;"
                           title="{% trans '프로필 편집' %}"
                           aria-label="{% trans '프로필 편집' %}">
                            {% trans "편집" %}
                        </a>
                        {% else %}
                        <button class="btn btn-ghost btn-sm dropdown-toggle profile-actions-toggle"
                                data-username="{{ profile_user.username }}"
                                data-user-id="{{ profile_user.id }}"
                                style="padding: 0.25rem 0.5rem; flex: 0 0 auto;"
                                title="사용자 작업"
                                aria-label="사용자 작업">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"/>
                                <circle cx="19" cy="12" r="1"/>
                                <circle cx="5" cy="12" r="1"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    {% if profile_user.bio %}
                        <p>{{ profile_user.bio }}</p>
                    {% endif %}
                    <div class="flex gap-sm mt-sm">
                        {% if profile_user.is_verified %}
                            <span class="badge badge-success">인증됨</span>
                        {% endif %}
                        {% if profile_user.is_premium %}
                            <span class="badge badge-accent">프리미엄</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-lg pt-lg pb-md" style="border-top: 1px solid var(--color-border);">
                <a href="{% url 'accounts:followers_list' profile_user.username %}" class="flex flex-col items-center gap-xs stat-link">
                    <div class="text-2xl font-bold" id="profile-follower-count">{{ profile_user.get_follower_count }}</div>
                    <div class="text-sm text-light">{% trans "팔로워" %}</div>
                </a>
                <a href="{% url 'accounts:following_list' profile_user.username %}" class="flex flex-col items-center gap-xs stat-link">
                    <div class="text-2xl font-bold" id="profile-following-count">{{ profile_user.get_following_count }}</div>
                    <div class="text-sm text-light">{% trans "팔로잉" %}</div>
                </a>
                <div class="flex flex-col items-center gap-xs">
                    <div class="text-2xl font-bold">{{ total_posts }}</div>
                    <div class="text-sm text-light">{% trans "포스트" %}</div>
                </div>
            </div>
        </div>
    </div>

    {% if suspension_info %}
    <!-- Suspension Alert (Own Profile) -->
    <div class="card mb-lg" style="background-color: #fef2f2; border: 2px solid #dc2626;">
        <div class="card-body">
            <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                </svg>
                <div style="flex: 1;">
                    <h2 style="margin: 0 0 var(--space-xs) 0; color: #dc2626; font-weight: 700; font-size: 1.5rem;">계정이 정지되었습니다</h2>
                    <p style="margin: 0; color: #991b1b; font-size: 1rem;">
                        <strong>정지 해제:</strong> {{ suspension_info.until|date:"Y년 m월 d일 H:i" }}
                        <span style="color: #dc2626; font-weight: 600;">({{ suspension_info.time_remaining }} 남음)</span>
                    </p>
                </div>
            </div>

            <div style="background: white; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: var(--space-sm); color: #374151;">정지 사유</h3>
                <p style="margin: 0; color: var(--color-text);">{{ suspension_info.reason }}</p>
            </div>

            <div style="background: white; padding: var(--space-md); border-radius: var(--radius-md);">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: var(--space-sm); color: #374151;">정지 중 제한사항</h3>
                <ul style="margin: 0; padding-left: var(--space-lg); color: var(--color-text);">
                    <li>게시물 작성 불가</li>
                    <li>댓글 작성 불가</li>
                    <li>채팅 및 매칭 불가</li>
                    <li>프로필 편집 불가</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% if admin_section %}
    <!-- Admin-Only Section -->
    <div class="card mb-lg" style="background-color: #fff5f5; border: 2px solid #f87171;">
        <div class="card-body">
            <div style="margin-bottom: var(--space-md);">
                <h2 style="margin: 0; color: #dc2626; font-weight: 700; font-size: 1.125rem;">관리자 전용 - 신고 정보</h2>
            </div>

            <!-- Report Statistics (Compact) -->
            <div style="background: white; padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); font-size: 0.8125rem;">
                <strong>신고:</strong>
                <span style="color: #dc2626; font-weight: 600;">전체 {{ admin_section.approved_report_count }}건</span> |
                <span style="color: #f97316; font-weight: 600;">활성 {{ admin_section.active_reports_count }}건</span> |
                <span style="color: #6366f1; font-weight: 600;">대기 {{ admin_section.pending_reports }}건</span>
            </div>

            <!-- Report Breakdown -->
            <div style="margin-bottom: var(--space-lg);">
                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: var(--space-sm); color: #374151;">유형별 신고 통계</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm); font-size: 0.8125rem;">
                    <div style="background: white; padding: var(--space-sm); border-radius: var(--radius-sm);">
                        <strong>게시물:</strong> {{ admin_section.report_breakdown.post_reports }}
                        <span style="color: #f97316;">({{ admin_section.active_report_breakdown.post_reports }} 활성)</span>
                    </div>
                    <div style="background: white; padding: var(--space-sm); border-radius: var(--radius-sm);">
                        <strong>댓글:</strong> {{ admin_section.report_breakdown.comment_reports }}
                        <span style="color: #f97316;">({{ admin_section.active_report_breakdown.comment_reports }} 활성)</span>
                    </div>
                    <div style="background: white; padding: var(--space-sm); border-radius: var(--radius-sm);">
                        <strong>채팅:</strong> {{ admin_section.report_breakdown.chat_reports }}
                        <span style="color: #f97316;">({{ admin_section.active_report_breakdown.chat_reports }} 활성)</span>
                    </div>
                </div>
            </div>

            <!-- Admin Action Buttons -->
            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                {% if profile_user.is_banned %}
                    <!-- Banned User: Only show unban button -->
                    <button onclick="confirmUnban('{{ profile_user.username }}')" class="btn" style="flex: 1; background-color: #10b981; color: white;">
                        밴 해제
                    </button>
                {% elif profile_user.is_currently_suspended %}
                    <!-- Suspended User: Show lift suspension and ban buttons -->
                    <button onclick="confirmLiftSuspension('{{ profile_user.username }}')" class="btn" style="flex: 1; background-color: #10b981; color: white;">
                        정지 해제
                    </button>
                    <button onclick="openBanModal('{{ profile_user.username }}')" class="btn" style="flex: 1; background-color: #dc2626; color: white;">
                        영구 정지
                    </button>
                {% else %}
                    <!-- Normal User: Show suspend and ban buttons -->
                    <button onclick="openSuspendModal('{{ profile_user.username }}')" class="btn" style="flex: 1; background-color: #f97316; color: white;">
                        정지하기
                    </button>
                    <button onclick="openBanModal('{{ profile_user.username }}')" class="btn" style="flex: 1; background-color: #dc2626; color: white;">
                        영구 정지
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if not is_own_profile %}
    <!-- Action Buttons -->
    <div class="flex gap-sm" style="max-width: 800px;">
        <button class="btn btn-primary follow-btn"
                data-username="{{ profile_user.username }}"
                data-user-id="{{ profile_user.id }}"
                onclick="toggleFollow('{{ profile_user.username }}', this)"
                style="flex: 1;">
            {% trans "팔로우" %}
        </button>
        <button class="btn btn-secondary"
                onclick="messageUser({{ profile_user.id }})"
                style="flex: 1;">
            {% trans "메시지" %}
        </button>
    </div>
    {% endif %}

    <!-- Posts Grid Section -->
    <div class="posts-grid-section" style="max-width: 1200px; width: 100%; margin-top: var(--space-lg);">
        <div class="card">
            <div class="card-body" style="padding: var(--space-md);">
                <!-- 검색바 섹션 -->
                <div class="search-bar-container mb-md">
                    <div class="search-input-wrapper">
                        <input
                            type="text"
                            id="post-search-input"
                            class="search-input"
                            placeholder="{% trans '게시물 검색... (내용 또는 #해시태그)' %}"
                            autocomplete="off"
                        >
                        <button id="clear-search-btn" class="clear-search-btn hidden" aria-label="{% trans '검색 지우기' %}">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="5" x2="15" y2="15"/>
                                <line x1="15" y1="5" x2="5" y2="15"/>
                            </svg>
                        </button>
                    </div>

                    <!-- 검색 결과 표시 -->
                    <div id="search-results-info" class="search-results-info hidden">
                        <span class="badge badge-secondary">{% trans '검색 결과' %}: <span id="search-result-count">0</span></span>
                    </div>
                </div>

                {% if initial_posts %}
                <!-- 3-Column Grid -->
                <div class="posts-grid" id="posts-grid">
                    {% for post in initial_posts %}
                    <div class="post-grid-item post-card"
                         data-post-id="{{ post.id }}"
                         data-post-index="{{ forloop.counter0 }}"
                         data-author-username="{{ post.author.username }}">
                        <!-- Thumbnail Container -->
                        <div class="post-thumbnail">
                            {% if is_own_profile %}
                            <!-- 게시물 옵션 버튼 (본인 프로필에서만 표시) -->
                            <button type="button"
                                    class="post-grid-options-btn dropdown-toggle"
                                    data-post-id="{{ post.id }}"
                                    data-author-username="{{ post.author.username }}"
                                    aria-label="{% trans '게시물 옵션' %}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="12" cy="5" r="2"/>
                                    <circle cx="12" cy="12" r="2"/>
                                    <circle cx="12" cy="19" r="2"/>
                                </svg>
                            </button>
                            {% endif %}

                            <!-- Text Preview -->
                            <div class="post-thumbnail-content">
                                <p class="post-preview-text">{{ post.content|truncatewords:10 }}</p>
                            </div>

                            <!-- Stats (Always Visible) -->
                            <div class="post-stats">
                                <span class="post-stat">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                    </svg>
                                    {{ post.like_count|default:0 }}
                                </span>
                                <span class="post-stat">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                    </svg>
                                    {{ post.comment_count|default:0 }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Empty State -->
                <div class="text-center" style="padding: var(--space-2xl);">
                    <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto var(--space-md); color: var(--color-text-lighter);">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <p class="text-light">{% trans '아직 게시물이 없습니다' %}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Post Viewer Modal -->
{% include 'partials/post_view_modal.html' %}

<!-- Post Action Modals -->
{% include 'partials/post_action_modal.html' %}
{% include 'partials/post_delete_modal.html' %}
{% include 'partials/alert_modal.html' %}

<!-- JavaScript for post actions -->
<script src="{% static 'js/post_actions.js' %}"></script>
<script src="{% static 'js/post_modal_viewer.js' %}"></script>

<script>
// 현재 로그인한 사용자 정보
window.CURRENT_USER = "{{ user.username }}";

// i18n translations for post actions JavaScript
window.POST_ACTIONS_I18N = {
    success: "{% trans '성공' %}",
    error: "{% trans '오류' %}",
    postDeleted: "{% trans '게시물이 삭제되었습니다.' %}",
    deleteFailed: "{% trans '삭제 실패' %}",
    serverError: "{% trans '서버 오류가 발생했습니다' %}",
    unknownError: "{% trans '알 수 없는 오류' %}",
    networkError: "{% trans '네트워크 오류가 발생했습니다. 다시 시도해주세요.' %}"
};

document.addEventListener('DOMContentLoaded', function() {
    // Post grid card click handler (event delegation)
    document.addEventListener('click', function(e) {
        const postCard = e.target.closest('.post-grid-item');
        if (postCard && !e.target.closest('.dropdown-toggle')) {
            const postId = postCard.dataset.postId;
            const postIndex = postCard.dataset.postIndex;
            if (postId && postIndex !== undefined) {
                openPostModal(postId, postIndex);
            }
        }
    });

    {% if is_own_profile %}
    const avatar = document.getElementById('profile-avatar');
    const fileInput = document.getElementById('profile-picture-input');
    const avatarImg = document.getElementById('avatar-img');
    const avatarSvg = document.getElementById('avatar-svg');
    const loadingOverlay = document.getElementById('avatar-loading');

    // Click avatar to trigger file picker
    avatar.addEventListener('click', function() {
        fileInput.click();
    });

    // Handle file selection and upload
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('이미지 파일만 업로드 가능합니다.');
            return;
        }

        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('파일 크기는 5MB 이하여야 합니다.');
            return;
        }

        // Show loading
        loadingOverlay.style.display = 'flex';

        // Prepare FormData
        const formData = new FormData();
        formData.append('profile_picture', file);

        try {
            // Upload via AJAX
            const response = await fetch('/api/accounts/update/', {
                method: 'PATCH',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                // Update avatar image
                if (result.user && result.user.profile_picture) {
                    if (avatarImg) {
                        avatarImg.src = result.user.profile_picture;
                    } else {
                        // Replace SVG with image
                        if (avatarSvg) avatarSvg.remove();
                        const newImg = document.createElement('img');
                        newImg.src = result.user.profile_picture;
                        newImg.alt = '{{ profile_user.username }}';
                        newImg.id = 'avatar-img';
                        avatar.insertBefore(newImg, loadingOverlay);
                    }
                }
                alert('프로필 사진이 업데이트되었습니다!');
            } else {
                const errorMsg = result.profile_picture || '업로드 중 오류가 발생했습니다.';
                alert(Array.isArray(errorMsg) ? errorMsg[0] : errorMsg);
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
        } finally {
            loadingOverlay.style.display = 'none';
            fileInput.value = '';
        }
    });
    {% endif %}

    {% if not is_own_profile %}
    // ==========================================
    // 초기 팔로우 상태 로드
    // ==========================================
    async function loadFollowStatus() {
        const followBtn = document.querySelector('.follow-btn');
        if (!followBtn) return;

        try {
            const response = await fetch('/api/accounts/{{ profile_user.username }}/follow-status/', {
                credentials: 'same-origin'
            });

            if (response.ok) {
                const data = await response.json();

                // 이미 팔로우 중이면 버튼 상태 업데이트
                if (data.is_following && data.is_follower) {
                    // 맞팔로우
                    followBtn.textContent = '맞팔로우';
                    followBtn.classList.remove('btn-primary');
                    followBtn.classList.add('btn-ghost');
                } else if (data.is_following) {
                    // 일반 팔로잉
                    followBtn.textContent = '팔로잉';
                    followBtn.classList.remove('btn-primary');
                    followBtn.classList.add('btn-ghost');
                }
            }
        } catch (error) {
            console.error('[Profile] Failed to load follow status:', error);
        }
    }

    // 팔로우 상태 로드 실행
    loadFollowStatus();
    {% endif %}

    // ==========================================
    // 게시글 검색 기능
    // ==========================================
    const PostSearch = {
        searchInput: null,
        clearBtn: null,
        resultsInfo: null,
        resultCount: null,
        postsGrid: null,
        originalPosts: [],
        debounceTimer: null,
        currentUsername: '{{ profile_user.username }}',

        init() {
            this.searchInput = document.getElementById('post-search-input');
            this.clearBtn = document.getElementById('clear-search-btn');
            this.resultsInfo = document.getElementById('search-results-info');
            this.resultCount = document.getElementById('search-result-count');
            this.postsGrid = document.getElementById('posts-grid');

            if (!this.searchInput || !this.postsGrid) return;

            // 초기 포스트 데이터 저장 (검색 취소 시 복원용)
            this.saveOriginalPosts();

            // 이벤트 리스너 등록
            this.attachEventListeners();
        },

        saveOriginalPosts() {
            const postItems = document.querySelectorAll('.post-grid-item');
            this.originalPosts = Array.from(postItems).map(item => item.cloneNode(true));
        },

        attachEventListeners() {
            // 검색 입력 (500ms debounce)
            this.searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                // X 버튼 표시/숨김
                this.clearBtn.style.display = query ? 'flex' : 'none';

                // Debounce 처리
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    if (query) {
                        this.performSearch(query);
                    } else {
                        this.resetSearch();
                    }
                }, 500);
            });

            // 검색 취소 버튼
            this.clearBtn.addEventListener('click', () => {
                this.searchInput.value = '';
                this.clearBtn.style.display = 'none';
                this.resetSearch();
                this.searchInput.focus();
            });

            // Enter 키 즉시 검색
            this.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(this.debounceTimer);
                    const query = this.searchInput.value.trim();
                    if (query) {
                        this.performSearch(query);
                    }
                }
            });
        },

        async performSearch(query) {
            try {
                // API 호출
                const response = await fetch(
                    `/api/accounts/${this.currentUsername}/posts/search/?q=${encodeURIComponent(query)}`
                );

                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();

                // 결과 표시
                this.displaySearchResults(data.results);

                // 결과 개수 업데이트
                this.resultCount.textContent = data.count || data.results.length;
                this.resultsInfo.style.display = 'flex';

            } catch (error) {
                console.error('Search error:', error);
                alert('검색 중 오류가 발생했습니다.');
            }
        },

        displaySearchResults(posts) {
            // 그리드 비우기
            this.postsGrid.innerHTML = '';

            if (posts.length === 0) {
                // 검색 결과 없음
                this.postsGrid.innerHTML = `
                    <div class="no-results-message" style="grid-column: 1 / -1; text-align: center; padding: var(--space-2xl);">
                        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto var(--space-md); color: var(--color-text-lighter);">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                        </svg>
                        <p class="text-light">{% trans '검색 결과가 없습니다' %}</p>
                    </div>
                `;
                return;
            }

            // 검색 결과 렌더링
            posts.forEach((post, index) => {
                const postItem = this.createPostGridItem(post, index);
                this.postsGrid.appendChild(postItem);
            });

            // 모달 뷰어 데이터 동기화
            if (window.postModalViewer) {
                postModalViewer.loadPostsData();
            }
        },

        createPostGridItem(post, index) {
            const div = document.createElement('div');
            div.className = 'post-grid-item';
            div.dataset.postId = post.id;
            div.dataset.postIndex = index;
            div.onclick = () => openPostModal(post.id, index);

            div.innerHTML = `
                <div class="post-thumbnail">
                    <div class="post-thumbnail-content">
                        <p class="post-preview-text">${this.truncateText(post.content, 10)}</p>
                    </div>

                    <div class="post-stats">
                        <span class="post-stat">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            ${post.like_count || 0}
                        </span>
                        <span class="post-stat">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                            </svg>
                            ${post.comment_count || 0}
                        </span>
                    </div>
                </div>
            `;

            return div;
        },

        truncateText(text, wordCount) {
            const words = text.split(' ');
            if (words.length <= wordCount) return text;
            return words.slice(0, wordCount).join(' ') + '...';
        },

        resetSearch() {
            // 검색 결과 정보 숨김
            this.resultsInfo.style.display = 'none';

            // 원본 포스트 복원
            this.postsGrid.innerHTML = '';
            this.originalPosts.forEach(post => {
                const clone = post.cloneNode(true);
                // 이벤트 리스너 재등록
                const postId = clone.dataset.postId;
                const postIndex = clone.dataset.postIndex;
                clone.onclick = () => openPostModal(postId, postIndex);
                this.postsGrid.appendChild(clone);
            });

            // 모달 뷰어 데이터 동기화
            if (window.postModalViewer) {
                postModalViewer.loadPostsData();
            }
        }
    };

    // 검색 기능 초기화
    PostSearch.init();
});
</script>

<script src="{% static 'js/post_modal_viewer.js' %}"></script>
{% endif %}

<!-- Admin Action Modals -->
{% if admin_section %}
<!-- Suspend Modal -->
<div id="suspendModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); max-width: 500px; width: 90%;">
        <h2 style="margin: 0 0 var(--space-md) 0; color: #dc2626;">계정 정지</h2>
        <div style="margin-bottom: var(--space-md);">
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600;">정지 기간 (일)</label>
            <input type="number" id="suspendDays" min="1" value="3" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
        </div>
        <div style="margin-bottom: var(--space-lg);">
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600;">정지 사유</label>
            <textarea id="suspendReason" rows="4" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);" placeholder="정지 사유를 입력하세요..."></textarea>
        </div>
        <div style="display: flex; gap: var(--space-sm);">
            <button onclick="closeSuspendModal()" class="btn btn-ghost" style="flex: 1;">취소</button>
            <button onclick="suspendUser()" class="btn" style="flex: 1; background-color: #f97316; color: white;">정지하기</button>
        </div>
    </div>
</div>

<!-- Ban Modal -->
<div id="banModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); max-width: 500px; width: 90%;">
        <h2 style="margin: 0 0 var(--space-md) 0; color: #dc2626;">영구 정지 (밴)</h2>
        <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-md);">
            <p style="margin: 0; color: #991b1b; font-size: 0.875rem;">
                ⚠️ 영구 정지는 해제하기 전까지 계정이 완전히 차단됩니다.
            </p>
        </div>
        <div style="margin-bottom: var(--space-lg);">
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600;">정지 사유</label>
            <textarea id="banReason" rows="4" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);" placeholder="영구 정지 사유를 입력하세요..."></textarea>
        </div>
        <div style="display: flex; gap: var(--space-sm);">
            <button onclick="closeBanModal()" class="btn btn-ghost" style="flex: 1;">취소</button>
            <button onclick="banUser()" class="btn" style="flex: 1; background-color: #dc2626; color: white;">영구 정지</button>
        </div>
    </div>
</div>

<!-- Admin Action JavaScript -->
<script>
let currentUsername = '';

// Suspend Modal
function openSuspendModal(username) {
    currentUsername = username;
    document.getElementById('suspendModal').style.display = 'flex';
}

function closeSuspendModal() {
    document.getElementById('suspendModal').style.display = 'none';
    document.getElementById('suspendDays').value = '3';
    document.getElementById('suspendReason').value = '';
}

async function suspendUser() {
    const days = document.getElementById('suspendDays').value;
    const reason = document.getElementById('suspendReason').value;

    if (!days || days < 1) {
        alert('정지 기간을 1일 이상 입력해주세요.');
        return;
    }

    try {
        const response = await fetch(`/accounts/api/admin/${currentUsername}/suspend/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                duration_days: parseInt(days),
                reason: reason
            })
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert(data.message || '정지 처리에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }

    closeSuspendModal();
}

// Ban Modal
function openBanModal(username) {
    currentUsername = username;
    document.getElementById('banModal').style.display = 'flex';
}

function closeBanModal() {
    document.getElementById('banModal').style.display = 'none';
    document.getElementById('banReason').value = '';
}

async function banUser() {
    const reason = document.getElementById('banReason').value;

    if (!confirm('정말로 이 계정을 영구 정지하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/accounts/api/admin/${currentUsername}/ban/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                reason: reason
            })
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert(data.message || '영구 정지 처리에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }

    closeBanModal();
}

// Lift Suspension
async function confirmLiftSuspension(username) {
    if (!confirm('정말로 정지를 해제하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/accounts/api/admin/${username}/lift-suspension/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert(data.message || '정지 해제에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
}

// Unban
async function confirmUnban(username) {
    if (!confirm('정말로 밴을 해제하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/accounts/api/admin/${username}/unban/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert(data.message || '밴 해제에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
}

// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endif %}

{% endblock %}
