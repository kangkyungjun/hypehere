{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "비밀번호 재설정 - HypeHere" %}{% endblock %}

{% block content %}
<div class="container" style="max-width: 480px; margin-top: var(--space-3xl);">
    <div class="card">
        <div class="card-body">
            <div class="text-center mb-lg">
                <h1 class="mb-sm">{% trans "비밀번호 재설정" %}</h1>
                <p class="text-light">{% trans "등록된 이메일 주소로 임시 비밀번호를 발송해드립니다" %}</p>
            </div>

            <!-- Error Alert (Hidden by default) -->
            <div id="error-alert" class="alert alert-error hidden" style="margin-bottom: var(--space-md);">
                <span id="error-message"></span>
            </div>

            <!-- Success Alert (Hidden by default) -->
            <div id="success-alert" class="alert alert-success hidden" style="margin-bottom: var(--space-md);">
                <span id="success-message"></span>
            </div>

            <form id="password-reset-form">
                {% csrf_token %}

                <div class="form-group">
                    <label for="email" class="form-label">{% trans "이메일 주소" %} *</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        class="form-control"
                        placeholder="{% trans 'example@email.com' %}"
                        required
                        autofocus
                    >
                    <span class="form-text">{% trans "가입 시 등록한 이메일 주소를 입력해주세요" %}</span>
                    <span class="form-error hidden" id="email-error"></span>
                </div>

                <button type="submit" class="btn btn-primary btn-block btn-lg" id="submit-btn">
                    <span id="submit-text">{% trans "임시 비밀번호 발송" %}</span>
                    <span id="submit-loading" class="spinner spinner-primary hidden"></span>
                </button>
            </form>

            <div class="text-center mt-lg">
                <p class="text-light">
                    {% trans "비밀번호가 기억나셨나요?" %}
                    <a href="{% url 'accounts:login' %}" class="text-primary font-semibold">{% trans "로그인" %}</a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for AJAX Password Reset -->
<script>
// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Show/Hide Alert Messages
function showAlert(type, message) {
    const alertId = type === 'error' ? 'error-alert' : 'success-alert';
    const messageId = type === 'error' ? 'error-message' : 'success-message';

    const alertElement = document.getElementById(alertId);
    const messageElement = document.getElementById(messageId);

    if (alertElement && messageElement) {
        messageElement.textContent = message;
        alertElement.classList.remove('hidden');

        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }
    }
}

function hideAlerts() {
    const errorAlert = document.getElementById('error-alert');
    const successAlert = document.getElementById('success-alert');

    if (errorAlert) errorAlert.classList.add('hidden');
    if (successAlert) successAlert.classList.add('hidden');
}

// Show/Hide Field Error
function showFieldError(fieldName, message) {
    const errorElement = document.getElementById(`${fieldName}-error`);
    const inputElement = document.getElementById(fieldName);

    if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
    }

    if (inputElement) {
        inputElement.classList.add('is-invalid');
    }
}

function clearFieldErrors() {
    const errorElements = document.querySelectorAll('.form-error');
    errorElements.forEach(element => {
        element.textContent = '';
        element.classList.add('hidden');
    });

    const inputs = document.querySelectorAll('.form-control');
    inputs.forEach(input => {
        input.classList.remove('is-invalid');
        input.classList.remove('is-valid');
    });
}

// Toggle Loading State
function setLoadingState(isLoading) {
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');

    if (submitBtn) {
        submitBtn.disabled = isLoading;
    }

    if (submitText && submitLoading) {
        if (isLoading) {
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');
        } else {
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
        }
    }
}

// Password Reset Form Handler
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('password-reset-form');

    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Clear previous errors
            hideAlerts();
            clearFieldErrors();

            // Get form data
            const email = document.getElementById('email').value.trim();

            // Client-side validation
            if (!email) {
                showFieldError('email', '{% trans "이메일 주소를 입력해주세요" %}');
                showAlert('error', '{% trans "이메일 주소를 입력해주세요" %}');
                return;
            }

            // Set loading state
            setLoadingState(true);

            try {
                // Send AJAX request to API
                const response = await fetch('{% url "accounts:password_reset_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ email: email })
                });

                const result = await response.json();

                if (response.ok) {
                    // Success
                    showAlert('success', result.message || '{% trans "임시 비밀번호가 이메일로 발송되었습니다" %}');

                    // Clear form
                    form.reset();

                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = '{% url "accounts:login" %}';
                    }, 3000);
                } else {
                    // Error
                    if (result.message) {
                        showAlert('error', result.message);
                    } else {
                        showAlert('error', '{% trans "오류가 발생했습니다. 다시 시도해주세요" %}');
                    }

                    setLoadingState(false);
                }
            } catch (error) {
                console.error('Password reset error:', error);
                showAlert('error', '{% trans "네트워크 오류가 발생했습니다. 다시 시도해주세요" %}');
                setLoadingState(false);
            }
        });
    }
});
</script>
{% endblock %}
