{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "계정 관리 - HypeHere" %}{% endblock %}

{% block content %}
<div class="privacy-settings-container">
    <div class="privacy-settings-card">
        <!-- 헤더 -->
        <div class="privacy-settings-header">
            <a href="{% url 'accounts:settings' %}" class="back-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </a>
            <h1 class="privacy-settings-title">{% trans "계정 관리" %}</h1>
        </div>

        <!-- 삭제 예약 알림 -->
        <div id="deletion-alert" class="deletion-alert hidden">
            <div class="alert-content">
                <svg class="alert-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div class="alert-text">
                    <h3>{% trans "계정 삭제 예약됨" %}</h3>
                    <p>{% blocktrans with days='<span id="days-remaining"></span>' %}{{ days }}일 후 영구 삭제됩니다.{% endblocktrans %}</p>
                </div>
            </div>
            <button id="btn-cancel-deletion" class="btn-cancel-deletion">{% trans "삭제 취소" %}</button>
        </div>

        <!-- 계정 관리 섹션 그리드 -->
        <div class="account-sections-grid">
            <!-- 비밀번호 변경 섹션 -->
            <div class="privacy-settings-section">
                <h2 class="privacy-settings-section-title">{% trans "비밀번호 변경" %}</h2>
                <div class="privacy-setting-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="privacy-setting-content" style="width: 100%; margin-bottom: var(--space-md);">
                        <div class="privacy-setting-text">
                            <div class="privacy-setting-label">{% trans "비밀번호 관리" %}</div>
                            <div class="privacy-setting-description">
                                {% trans "계정 보안을 위해 정기적으로 비밀번호를 변경하세요" %}
                            </div>
                        </div>
                    </div>
                    <button id="btn-change-password" class="btn-primary">{% trans "비밀번호 변경" %}</button>
                </div>
            </div>

            <!-- 비활성화/재활성화 섹션 -->
            <div class="privacy-settings-section">
                {% if user.is_deactivated %}
                    <h2 class="privacy-settings-section-title">{% trans "계정 재활성화" %}</h2>
                    <div class="privacy-setting-item" style="flex-direction: column; align-items: flex-start;">
                        <div class="privacy-setting-content" style="width: 100%; margin-bottom: var(--space-md);">
                            <div class="privacy-setting-text">
                                <div class="privacy-setting-label">{% trans "계정 다시 활성화" %}</div>
                                <div class="privacy-setting-description">
                                    {% trans "비활성화된 계정을 다시 활성화하여 모든 기능을 이용할 수 있습니다" %}
                                </div>
                            </div>
                        </div>
                        <button id="btn-reactivate" class="btn-primary">{% trans "재활성화" %}</button>
                    </div>
                {% else %}
                    <h2 class="privacy-settings-section-title">{% trans "계정 비활성화" %}</h2>
                    <div class="privacy-setting-item" style="flex-direction: column; align-items: flex-start;">
                        <div class="privacy-setting-content" style="width: 100%; margin-bottom: var(--space-md);">
                            <div class="privacy-setting-text">
                                <div class="privacy-setting-label">{% trans "계정 일시 정지" %}</div>
                                <div class="privacy-setting-description">
                                    {% trans "프로필이 숨겨지지만 언제든지 다시 로그인하여 복구할 수 있습니다" %}
                                </div>
                            </div>
                        </div>
                        <button id="btn-deactivate" class="btn-deactivate">{% trans "비활성화" %}</button>
                    </div>
                {% endif %}
            </div>

            <!-- 삭제 섹션 -->
            <div class="privacy-settings-section danger-section">
                <h2 class="privacy-settings-section-title">{% trans "계정 영구 삭제" %}</h2>
                <div class="privacy-setting-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="privacy-setting-content" style="width: 100%; margin-bottom: var(--space-md);">
                        <div class="privacy-setting-text">
                            <div class="privacy-setting-label">{% trans "계정 삭제" %}</div>
                            <div class="privacy-setting-description">
                                {% trans "30일 후 계정과 모든 데이터가 영구적으로 삭제됩니다. 이 작업은 되돌릴 수 없습니다." %}
                            </div>
                        </div>
                    </div>
                    <button id="btn-delete" class="btn-delete">{% trans "삭제 요청" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 비활성화 확인 모달 -->
<div id="deactivate-modal" class="modal hidden">
    <div class="modal-overlay" data-action="close-modal" data-modal-id="deactivate-modal"></div>
    <div class="modal-content">
        <h2>{% trans "계정을 비활성화하시겠습니까?" %}</h2>
        <p>{% trans "프로필과 게시글이 숨겨지지만 언제든 다시 로그인하여 복구할 수 있습니다." %}</p>
        <div class="modal-actions">
            <button class="btn-cancel" data-action="close-modal" data-modal-id="deactivate-modal">{% trans "취소" %}</button>
            <button class="btn-confirm" id="confirm-deactivate">{% trans "비활성화" %}</button>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 Step 1 -->
<div id="delete-modal-step1" class="modal hidden">
    <div class="modal-overlay" data-action="close-modal" data-modal-id="delete-modal-step1"></div>
    <div class="modal-content">
        <h2>{% trans "정말로 계정을 삭제하시겠습니까?" %}</h2>
        <p>{% trans "30일 후 다음 항목이 영구적으로 삭제됩니다:" %}</p>
        <ul style="text-align: left; margin: var(--space-md) 0;">
            <li>{% trans "프로필 정보" %}</li>
            <li>{% trans "모든 게시글 및 댓글" %}</li>
            <li>{% trans "팔로워 및 팔로잉 관계" %}</li>
            <li>{% trans "모든 활동 기록" %}</li>
        </ul>
        <div class="modal-actions">
            <button class="btn-cancel" data-action="close-modal" data-modal-id="delete-modal-step1">{% trans "취소" %}</button>
            <button class="btn-next" id="next-step2">{% trans "다음" %}</button>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 Step 2 -->
<div id="delete-modal-step2" class="modal hidden">
    <div class="modal-overlay" data-action="close-modal" data-modal-id="delete-modal-step2"></div>
    <div class="modal-content">
        <h2>{% trans "계정 삭제 확인" %}</h2>
        <p>{% blocktrans %} 계속하려면 "<strong>영구삭제</strong>"를 입력하세요:{% endblocktrans %}</p>
        <input type="text" id="delete-confirm-text" placeholder="{% trans "영구삭제" %}" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md); margin: var(--space-md) 0;"/>
        <div class="modal-actions">
            <button class="btn-cancel" data-action="close-modal" data-modal-id="delete-modal-step2">{% trans "취소" %}</button>
            <button class="btn-danger" id="confirm-delete" disabled>{% trans "삭제 요청" %}</button>
        </div>
    </div>
</div>

<!-- 비활성화 성공 모달 -->
<div id="deactivate-success-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: var(--space-lg);">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" style="margin: 0 auto;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
        </div>
        <h2 style="text-align: center;">{% trans "계정이 비활성화되었습니다" %}</h2>
        <p style="text-align: center; margin: var(--space-md) 0;">
            {% trans "계정을 재활성화하려면 재활성화 버튼을 눌러주세요." %}
        </p>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-primary" id="deactivate-success-ok">{% trans "확인" %}</button>
        </div>
    </div>
</div>

<!-- 재활성화 확인 모달 -->
<div id="reactivate-modal" class="modal hidden">
    <div class="modal-overlay" data-action="close-modal" data-modal-id="reactivate-modal"></div>
    <div class="modal-content">
        <h2>{% trans "계정을 재활성화하시겠습니까?" %}</h2>
        <p>{% trans "모든 기능을 다시 사용할 수 있게 됩니다." %}</p>
        <div class="modal-actions">
            <button class="btn-cancel" data-action="close-modal" data-modal-id="reactivate-modal">{% trans "취소" %}</button>
            <button class="btn-confirm" id="confirm-reactivate">{% trans "재활성화" %}</button>
        </div>
    </div>
</div>

<!-- 재활성화 성공 모달 -->
<div id="reactivate-success-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: var(--space-lg);">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" style="margin: 0 auto;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
        </div>
        <h2 style="text-align: center;">{% trans "계정이 재활성화되었습니다" %}</h2>
        <p style="text-align: center; margin: var(--space-md) 0;">
            {% trans "이제 모든 기능을 사용할 수 있습니다." %}
        </p>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-primary" id="reactivate-success-ok">{% trans "확인" %}</button>
        </div>
    </div>
</div>

<!-- 비밀번호 변경 모달 -->
<div id="password-change-modal" class="modal hidden">
    <div class="modal-overlay" data-action="close-modal" data-modal-id="password-change-modal"></div>
    <div class="modal-content">
        <h2>{% trans "비밀번호 변경" %}</h2>
        <p style="margin-bottom: var(--space-md);">{% trans "새로운 비밀번호를 입력해주세요" %}</p>

        <!-- Error Alert (Hidden by default) -->
        <div id="password-error-alert" class="alert alert-error hidden" style="margin-bottom: var(--space-md); text-align: left;">
            <span id="password-error-message"></span>
        </div>

        <form id="password-change-form" style="display: flex; flex-direction: column; gap: var(--space-md);">
            <div class="form-group">
                <label for="old_password" class="form-label" style="display: block; text-align: left; margin-bottom: var(--space-xs); font-weight: 600;">{% trans "현재 비밀번호" %}</label>
                <input
                    type="password"
                    id="old_password"
                    name="old_password"
                    class="form-control"
                    placeholder="{% trans '현재 비밀번호' %}"
                    required
                    style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);"
                >
            </div>

            <div class="form-group">
                <label for="new_password" class="form-label" style="display: block; text-align: left; margin-bottom: var(--space-xs); font-weight: 600;">
                    {% trans "새 비밀번호" %}
                    <button type="button" id="password-rules-trigger" class="password-info-icon" aria-label="{% trans '비밀번호 규칙 보기' %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </button>
                </label>
                <input
                    type="password"
                    id="new_password"
                    name="new_password"
                    class="form-control"
                    placeholder="{% trans '새 비밀번호' %}"
                    required
                    style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);"
                >
            </div>

            <div class="form-group">
                <label for="new_password_confirm" class="form-label" style="display: block; text-align: left; margin-bottom: var(--space-xs); font-weight: 600;">{% trans "새 비밀번호 확인" %}</label>
                <input
                    type="password"
                    id="new_password_confirm"
                    name="new_password_confirm"
                    class="form-control"
                    placeholder="{% trans '새 비밀번호 확인' %}"
                    required
                    style="width: 100%; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);"
                >
            </div>
        </form>

        <div class="modal-actions">
            <button class="btn-cancel" data-action="close-modal" data-modal-id="password-change-modal">{% trans "취소" %}</button>
            <button class="btn-confirm" id="confirm-password-change">{% trans "변경하기" %}</button>
        </div>
    </div>
</div>

<script>
// Password Change i18n Context
window.PASSWORD_CHANGE_I18N = {
    // Error messages
    allFieldsRequired: "{% trans '모든 필드를 입력해주세요.' %}",
    passwordMismatch: "{% trans '새 비밀번호가 일치하지 않습니다.' %}",
    passwordTooShort: "{% trans '비밀번호는 최소 8자 이상이어야 합니다.' %}",
    passwordChangeFailed: "{% trans '비밀번호 변경에 실패했습니다.' %}",
    passwordChangeError: "{% trans '비밀번호 변경 중 오류가 발생했습니다.' %}",
    networkError: "{% trans '네트워크 오류가 발생했습니다. 다시 시도해주세요.' %}"
};
</script>

<!-- 비밀번호 변경 성공 모달 -->
<div id="password-change-success-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: var(--space-lg);">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" style="margin: 0 auto;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
        </div>
        <h2 style="text-align: center;">{% trans "비밀번호가 변경되었습니다" %}</h2>
        <p style="text-align: center; margin: var(--space-md) 0;">
            {% trans "새로운 비밀번호로 로그인해주세요." %}
        </p>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-primary" id="password-change-success-ok">{% trans "확인" %}</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/password_rules_modal.css' %}">
<style>
/* 기본 스타일은 privacy_settings.html에서 상속 */

/* 헤더 레이아웃 수정 - 가로 배열 */
.privacy-settings-header {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    margin-bottom: var(--space-xl);
}

.back-button {
    position: absolute;
    left: 0;
}

.privacy-settings-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
}

/* 계정 섹션 그리드 레이아웃 */
.account-sections-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-xl);
    margin-bottom: var(--space-xl);
}

/* 현대적 카드 스타일 */
.privacy-settings-section {
    background: white;
    border-radius: 16px;
    padding: var(--space-xl);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
}

.privacy-settings-section:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

/* 타이틀 단색 */
.privacy-settings-section-title {
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    margin-bottom: var(--space-lg) !important;
    color: #667eea;
}

.danger-section .privacy-settings-section-title {
    color: #f5576c !important;
}

/* 아이콘 제거 - SVG가 없으므로 스타일 불필요 */

/* 레이블 스타일 */
.privacy-setting-label {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
}

.privacy-setting-description {
    color: var(--color-text-light);
    line-height: 1.6;
}

/* 모바일 반응형 */
@media (max-width: 767px) {
    .account-sections-grid {
        grid-template-columns: 1fr;
        gap: var(--space-lg);
    }

    .privacy-settings-section {
        padding: var(--space-lg);
    }

    .privacy-settings-section-title {
        font-size: 1.25rem !important;
    }

    .privacy-setting-content svg {
        width: 40px !important;
        height: 40px !important;
        padding: 10px;
    }
}

/* 알림 박스 */
.deletion-alert {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.alert-content {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.alert-icon {
    flex-shrink: 0;
    color: #856404;
}

.alert-text h3 {
    margin: 0 0 var(--space-xs) 0;
    font-size: 1rem;
    font-weight: 600;
    color: #856404;
}

.alert-text p {
    margin: 0;
    font-size: 0.875rem;
    color: #856404;
}

.btn-cancel-deletion {
    background: #ffc107;
    color: #856404;
    border: none;
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
}

/* 버튼 현대화 */
.btn-deactivate,
.btn-delete {
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    width: 100%;
}

.btn-deactivate {
    background: #667eea;
    color: white;
}

.btn-deactivate:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
}

.btn-delete {
    background: #f5576c;
    color: white;
}

.btn-delete:hover {
    background: #e03e53;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(245, 87, 108, 0.4);
}

.btn-delete:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* 모달 */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: var(--z-modal);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: var(--z-modal-backdrop);
}

.modal-content {
    position: relative;
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: var(--shadow-lg);
    z-index: var(--z-modal);
}

.modal-content h2 {
    margin: 0 0 var(--space-md) 0;
    font-size: 1.25rem;
    color: var(--color-text);
}

.modal-content p {
    margin: 0 0 var(--space-md) 0;
    color: var(--color-text-light);
}

.modal-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
    margin-top: var(--space-lg);
}

.btn-cancel,
.btn-confirm,
.btn-next,
.btn-danger {
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-cancel {
    background: var(--color-hover);
    color: var(--color-text);
}

.btn-confirm,
.btn-next {
    background: var(--color-primary);
    color: white;
}

.btn-danger {
    background: var(--color-danger);
    color: white;
}

.btn-danger:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<!-- Password Rules Modal -->
{% include 'partials/password_rules_modal.html' %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/account_management.js' %}"></script>
<script src="{% static 'js/password_rules_modal.js' %}"></script>
{% endblock %}
