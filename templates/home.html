{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "HypeHere - 언어교환 플랫폼" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home-search.css' %}">
{% endblock %}

{% block content %}
{% if user.is_authenticated %}
    {% if user.is_deactivated %}
        <!-- 비활성화된 유저용 안내 화면 -->
        <div class="card" style="text-align: center; padding: var(--space-2xl); margin: var(--space-lg) auto; max-width: 600px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto var(--space-lg); color: var(--color-warning);">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h3 style="margin-bottom: var(--space-md);">{% trans "계정이 비활성화되었습니다" %}</h3>
            <p class="text-light" style="margin-bottom: var(--space-lg);">
                {% trans "계정을 재활성화하면 모든 기능을 다시 사용할 수 있습니다." %}
            </p>
            <a href="{% url 'accounts:account_management' %}" class="btn btn-primary">
                {% trans "재활성화 하기" %}
            </a>
        </div>
    {% else %}
    <!-- Search Section -->
    <div class="home-search-section">
        <div class="home-search-container">
            <svg class="home-search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input
                type="text"
                id="home-search-input"
                class="home-search-input"
                placeholder="{% trans '사용자 및 게시물 검색...' %}"
                autocomplete="off"
            />
        </div>
    </div>

    <!-- Authenticated User - Feed -->
    <div class="feed-container">
        {% if posts %}
            {% for post in posts %}
            <!-- Post Card -->
            <div class="post-card" data-post-id="{{ post.id }}" data-author-username="{{ post.author.username }}" data-can-edit="{{ post.can_edit|yesno:'true,false' }}" data-can-delete="{{ post.can_delete|yesno:'true,false' }}" style="border: none; box-shadow: none; border-bottom: 1px solid rgba(0, 0, 0, 0.06);">
            <div class="post-header">
                <div class="avatar">
                    {% if post.author.profile_picture %}
                        <img src="{{ post.author.profile_picture.url }}" alt="{{ post.author.nickname }}">
                    {% else %}
                        <svg viewBox="0 0 100 100" fill="currentColor" style="color: var(--color-secondary);">
                            <circle cx="50" cy="35" r="20"/>
                            <path d="M15 85 Q15 55 50 55 Q85 55 85 85 Z"/>
                        </svg>
                    {% endif %}
                </div>
                <div class="post-author-info">
                    <a href="{% url 'accounts:profile_detail' post.author.username %}" class="post-author-name">{{ post.author.nickname }}</a>
                    <div class="post-meta">
                        {% if post.native_language and post.target_language %}
                        <span>{{ post.get_native_language_display|slice:":2" }} → {{ post.get_target_language_display|slice:":2" }}</span>
                        <span>•</span>
                        {% endif %}
                        <span class="post-time" data-timestamp="{{ post.created_at.isoformat }}">{{ post.created_at|timesince }}</span>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-ghost btn-sm dropdown-toggle">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"/>
                            <circle cx="19" cy="12" r="1"/>
                            <circle cx="5" cy="12" r="1"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Post Images (if any) -->
            {% if post.images.exists %}
            <div class="post-images-container">
                <div class="post-images-gallery {% if post.images.count == 1 %}single-image{% else %}multiple-images{% endif %}">
                    {% for image in post.images.all %}
                    <img src="{{ image.image.url }}"
                         alt="Post image {{ forloop.counter }}"
                         class="post-feed-image">
                    {% endfor %}
                </div>
                {% if post.images.count > 1 %}
                <div class="image-counter">1/{{ post.images.count }}</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="post-content">
                <p>{{ post.content|linebreaksbr }}</p>
                {% if post.hashtags.exists %}
                <div class="flex gap-xs mt-sm">
                    {% for hashtag in post.hashtags.all %}
                    <span class="badge badge-primary">#{{ hashtag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="post-actions">
                <button class="post-action-btn feed-like-btn{% if post.is_liked %} liked{% endif %}" data-post-id="{{ post.id }}">
                    <svg width="20" height="20" viewBox="0 0 24 24" {% if post.is_liked %}fill="currentColor"{% else %}fill="none"{% endif %} stroke="currentColor" stroke-width="2" class="like-icon">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span class="like-text">{% trans "좋아요" %}</span>
                    <span class="like-count">{{ post.like_count }}</span>
                </button>
                <button class="post-action-btn feed-comment-btn" data-post-id="{{ post.id }}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                    <span class="comment-count">{{ post.comment_count }}</span>
                </button>
                <button class="post-action-btn share-btn" data-post-id="{{ post.id }}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                </button>
                <button class="post-action-btn feed-favorite-btn{% if post.is_favorited %} favorited{% endif %}" data-post-id="{{ post.id }}">
                    <svg width="20" height="20" viewBox="0 0 24 24" {% if post.is_favorited %}fill="currentColor"{% else %}fill="none"{% endif %} stroke="currentColor" stroke-width="2" class="favorite-icon">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                </button>
            </div>

            <!-- Comments Section (Initially Hidden) -->
            <div class="post-comments hidden" id="comments-{{ post.id }}">
                <div class="comments-list" data-post-id="{{ post.id }}">
                    <!-- Comments will be loaded here dynamically -->
                </div>
                <div class="comment-form">
                    <textarea
                        class="comment-input"
                        placeholder="{% trans '댓글을 입력하세요...' %}"
                        maxlength="500"
                        rows="2"
                        data-post-id="{{ post.id }}"
                    ></textarea>
                    <button type="button" class="btn btn-primary btn-sm submit-comment-btn" data-post-id="{{ post.id }}">
                        {% trans "댓글 달기" %}
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <!-- Empty State -->
        <div class="card" style="text-align: center; padding: var(--space-2xl);">
            <h3 style="margin-bottom: var(--space-md);">{% trans "아직 게시물이 없습니다" %}</h3>
            <p class="text-light" style="margin-bottom: var(--space-lg);">{% trans "첫 번째 게시물을 작성해보세요!" %}</p>
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto; color: var(--color-text-lighter);">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        </div>
        {% endif %}
    </div>
    {% endif %}

{% else %}
    <!-- Guest User - Landing Page -->
    <div style="text-align: center; padding: var(--space-xl) var(--space-sm); max-width: 100%; overflow-x: hidden;">
        <!-- Hero Section -->
        <div style="max-width: 100%; padding: 0 var(--space-md); margin: 0 auto;">
            <p style="font-size: var(--font-size-xl); color: var(--color-text-light); margin-bottom: var(--space-2xl); line-height: var(--line-height-relaxed);">
                {% blocktrans %}HypeHere는 전 세계 사람들과 언어를 교환하며<br>
                진정한 친구 관계를 만드는 SNS형 플랫폼입니다.{% endblocktrans %}
            </p>
        </div>

        <!-- CTA Section -->
        <div style="margin-top: var(--space-xl); padding: var(--space-lg); background-color: var(--color-bg-secondary); border-radius: var(--radius-xl); max-width: 100%;">
            <h2 class="mb-md">{% trans "지금 바로 시작하세요!" %}</h2>
            <p class="text-lg text-light mb-lg">{% trans "가입하고 첫 번째 언어 교환 친구를 만나보세요." %}</p>
            <a href="{% url 'accounts:register' %}" class="btn btn-primary btn-lg">
                {% trans "무료 회원가입" %}
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Current logged-in user information for JavaScript
    window.CURRENT_USER = "{{ user.username }}";
    window.CURRENT_USER_ID = {{ user.id|default:"null" }};

    // i18n translations for post actions JavaScript
    window.POST_ACTIONS_I18N = {
        edit: "{% trans '수정' %}",
        delete: "{% trans '삭제' %}",
        block: "{% trans '차단' %}",
        report: "{% trans '신고' %}",
        success: "{% trans '성공' %}",
        error: "{% trans '오류' %}",
        confirmLeaveRoom: "{% trans '정말로 이 대화방을 나가시겠습니까?' %}\n\n{% trans '대화 기록이 모두 삭제됩니다.' %}",
        leftRoom: "{% trans '대화방을 나갔습니다.' %}",
        leaveRoomError: "{% trans '대화방 나가기 중 오류가 발생했습니다.' %}",
        networkError: "{% trans '네트워크 오류가 발생했습니다. 다시 시도해주세요.' %}",
        confirmBlock: "{% trans '차단하시겠습니까?' %}",
        blockUserInput: "{% trans '차단할 사용자의 아이디를 입력하세요' %}",
        cannotFindPost: "{% trans '신고할 게시물 정보를 찾을 수 없습니다.' %}",
        selectReportType: "{% trans '신고 유형을 선택해주세요.' %}",
        reportSubmitted: "{% trans '신고가 접수되었습니다.' %}\n\n{% trans '검토 후 조치하겠습니다.' %}",
        reportError: "{% trans '신고 접수 중 오류가 발생했습니다.' %}",
        editComingSoon: "{% trans '수정 기능은 곧 구현될 예정입니다.' %}\n\n{% trans '게시물 수정 모달이 곧 추가됩니다.' %}",
        confirmDelete: "{% trans '정말로 이 게시물을 삭제하시겠습니까?' %}\n\n{% trans '삭제된 게시물은 복구할 수 없습니다.' %}",
        postDeleted: "{% trans '게시물이 삭제되었습니다.' %}",
        deleteError: "{% trans '게시물 삭제 중 오류가 발생했습니다.' %}"
    };

    // i18n translations for post creation modal JavaScript
    window.POST_MODAL_I18N = {
        charCounter: "{% trans 'chars' %}",
        errorEmptyContent: "{% trans '게시물 내용을 입력해주세요.' %}",
        errorMaxLength: "{% trans '게시물은 최대 1000자까지 작성할 수 있습니다.' %}",
        errorSubmit: "{% trans '게시물 작성 중 오류가 발생했습니다.' %}",
        errorNetwork: "{% trans '네트워크 오류가 발생했습니다. 다시 시도해주세요.' %}",
        modalTitle: "{% trans '언어 선택' %}",
        placeholderNone: "{% trans '선택 안함' %}",
        placeholderSearch: "{% trans '언어 검색' %}",
        emptySearchResult: "{% trans '검색 결과가 없습니다' %}"
    };

    // URL 쿼리 파라미터로 게시글 모달 자동 오픈
    document.addEventListener('DOMContentLoaded', () => {
        // URL에서 postId 쿼리 파라미터 확인
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('postId');

        if (postId) {
            console.log('[Home] 쿼리 파라미터로 게시글 모달 오픈:', postId);

            // PostModalViewer 인스턴스 생성 또는 가져오기
            if (!window.postModalViewer) {
                window.postModalViewer = new PostModalViewer();
            }

            // posts 배열 동적 생성 (단일 게시글)
            window.postModalViewer.posts = [{
                id: parseInt(postId),
                index: 0,
                element: null
            }];

            // 모달 열기 (약간의 지연을 줘서 DOM이 완전히 로드되도록)
            setTimeout(() => {
                window.postModalViewer.openModal(parseInt(postId), 0);
            }, 100);

            // URL에서 쿼리 파라미터 제거 (뒤로가기 시 모달 재오픈 방지)
            window.history.replaceState({}, '', window.location.pathname);
        }

        // 이미지 뷰어 클릭 기능 활성화
        if (typeof attachImageViewers === 'function') {
            attachImageViewers('.post-feed-image');
        }
    });
</script>
{% endblock %}
