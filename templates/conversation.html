{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block body_class %}conversation-page{% endblock %}

{% block title %}{{ other_user.username }} - {% trans "메시지 - HypeHere" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/messages.css' %}">
{% endblock %}

{% block content %}
<div class="conversation-detail-container">
    <!-- 채팅 헤더 -->
    <div class="chat-header">
        <a href="{% url 'chat:messages' %}" class="back-button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </a>
        <a href="{% url 'accounts:profile_detail' other_user.username %}" class="chat-header-user-link">
            {% if other_user.profile_picture %}
                <img class="chat-header-avatar" src="{{ other_user.profile_picture.url }}" alt="{{ other_user.username }}">
            {% else %}
                <div class="chat-header-avatar">
                    <svg viewBox="0 0 100 100" fill="currentColor" style="color: var(--color-primary);">
                        <circle cx="50" cy="35" r="20"/>
                        <path d="M15 85 Q15 55 50 55 Q85 55 85 85 Z"/>
                    </svg>
                </div>
            {% endif %}
            <div class="chat-header-info">
                <h3>{{ other_user.username }}</h3>
            </div>
        </a>

        <!-- 오른쪽 버튼 그룹 -->
        <div class="chat-header-actions">
            <!-- 점 세개 버튼 -->
            <button class="btn btn-ghost btn-sm chat-actions-toggle"
                    data-username="{{ other_user.username }}"
                    data-user-id="{{ other_user.id }}"
                    id="chat-actions-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"/>
                    <circle cx="19" cy="12" r="1"/>
                    <circle cx="5" cy="12" r="1"/>
                </svg>
            </button>

            <!-- 방 나가기 버튼 -->
            <button class="btn btn-ghost btn-sm leave-room-btn" data-conversation-id="{{ conversation_id }}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span class="leave-room-text">{% trans "방 나가기" %}</span>
            </button>
        </div>
    </div>

    <!-- 메시지 리스트 -->
    <div class="messages-list" id="messages-list">
        <!-- 메시지가 JavaScript로 동적으로 로드됨 -->
    </div>

    <!-- 메시지 입력 -->
    <div class="message-input-container">
        <textarea
            id="message-input"
            class="message-input"
            placeholder="{% trans '메시지를 입력하세요...' %}"
            rows="1"
        ></textarea>
        <button class="send-button" id="send-button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13"/>
                <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
            </svg>
        </button>
    </div>
</div>

<!-- Leave Conversation Modal -->
<div id="leave-conversation-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{% trans '대화방 나가기' %}</h3>
            <button id="close-leave-conversation-modal" class="btn-icon" aria-label="{% trans '닫기' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="text-align: center; margin: 1rem 0; font-size: 1rem;">
                {% trans '정말로 이 대화방을 나가시겠습니까?' %}
            </p>
            <p style="text-align: center; margin: 0.5rem 0; font-size: 0.875rem; color: #ef4444;">
                {% trans '대화 기록이 모두 삭제됩니다.' %}
            </p>
        </div>
        <div class="modal-footer">
            <button id="confirm-leave-conversation" class="btn btn-danger">{% trans '나가기' %}</button>
            <button id="cancel-leave-conversation" class="btn btn-secondary">{% trans '취소' %}</button>
        </div>
    </div>
</div>

<!-- CSRF Token for API requests -->
{% csrf_token %}

<!-- Include Action Modal -->
{% include 'partials/message_action_modal.html' %}

<!-- Include Report Modal -->
{% include 'partials/message_report_modal.html' %}

<!-- Block User Modal is already included in base.html -->
{% endblock %}

{% block extra_js %}
<script>
    // 템플릿에서 conversation_id 전달
    window.CONVERSATION_ID = {{ conversation_id }};
    // Current logged-in user information for JavaScript
    window.CURRENT_USER = "{{ user.username }}";
</script>
<script src="{% static 'js/conversation.js' %}"></script>
{% endblock %}
