{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title_ko }} - {{ lesson.category.name_ko }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/situation-learning.css' %}">
{% endblock %}

{% block content %}
<div class="situation-container">
    <!-- Header -->
    <div class="situation-header">
        <a href="{% url 'learning:situation_lessons' lesson.category.code %}?language={{ selected_language }}" class="back-btn">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
        </a>
        <div class="lesson-header-info">
            <div class="lesson-breadcrumb">
                {{ lesson.category.icon }} {{ lesson.category.name_ko }}
            </div>
            <h1 class="lesson-detail-title-ko">{{ lesson.title_ko }}</h1>
            <p class="lesson-detail-title-en">{{ lesson.title_en }}</p>
        </div>
    </div>

    <!-- Expressions Slider -->
    <div class="expression-slider-wrapper">
        <!-- Navigation Buttons (Desktop Only) -->
        <button class="slider-nav slider-nav-prev" aria-label="이전 표현">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>

        <div class="expressions-section">
            {% for expression in expressions %}
            <div class="expression-card" data-order="{{ expression.order }}" data-index="{{ forloop.counter }}" data-expression-id="{{ expression.id }}">
                <!-- Action Buttons Container -->
                <div class="expression-actions">
                    <!-- Bookmark Button -->
                    <button class="bookmark-btn" aria-label="북마크" data-expression-id="{{ expression.id }}">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                        </svg>
                    </button>

                    <!-- Admin Edit/Delete Buttons (Staff Only) -->
                    {% if user.is_staff %}
                    <button class="admin-edit-btn" aria-label="수정" data-expression-id="{{ expression.id }}" title="표현 수정">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="admin-delete-btn" aria-label="삭제" data-expression-id="{{ expression.id }}" title="표현 삭제">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>

                <!-- Main Expression -->
            <div class="expression-main">
                <h3 class="expression-korean">{{ expression.expression }}</h3>
                <p class="expression-translation">{{ expression.translation }}</p>
                <p class="expression-pronunciation">[{{ expression.pronunciation }}]</p>
            </div>

            <!-- Situation Context -->
            <div class="expression-context">
                <div class="context-text">
                    {{ expression.situation_context }}
                </div>
            </div>

            <!-- Vocabulary Section -->
            {% if expression.vocabulary %}
            <div class="vocabulary-section">
                <ul class="vocab-list">
                    {% for vocab in expression.vocabulary %}
                    <li class="vocab-item">
                        <span class="vocab-word">{{ vocab.word }}</span>
                        <span class="vocab-pronunciation">[{{ vocab.word|lower }}]</span>
                        <span class="vocab-meaning">{{ vocab.meaning }}</span>
                        {% if vocab.example %}
                        <div class="vocab-example">예: {{ vocab.example }}</div>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
            {% empty %}
            <div class="empty-state">
                <p>아직 표현이 추가되지 않았습니다.</p>
            </div>
            {% endfor %}
        </div>

        <button class="slider-nav slider-nav-next" aria-label="다음 표현">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
            </svg>
        </button>
    </div>

    <!-- Expression Pagination Indicator -->
    <div class="expression-pagination">
        <span class="current-expression">1</span>/<span class="total-expressions">{{ expressions|length }}</span>
    </div>

    <!-- Admin Add Expression Button (Staff Only) -->
    {% if user.is_staff %}
    <button class="admin-add-btn" aria-label="표현 추가" title="새 표현 추가" data-lesson-id="{{ lesson.id }}">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
    </button>
    {% endif %}
</div>

<!-- Admin Expression Modal (Staff Only) -->
{% if user.is_staff %}
<div id="expressionModal" class="admin-modal" class="hidden">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="modalTitle">표현 추가</h2>
            <button class="modal-close-btn" aria-label="닫기">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <form id="expressionForm" class="modal-form">
            <input type="hidden" id="expressionId" name="expression_id">
            <input type="hidden" id="lessonId" name="lesson" value="{{ lesson.id }}">

            <div class="form-group">
                <label for="expression">한국어 표현 <span class="required">*</span></label>
                <input type="text" id="expression" name="expression" required placeholder="안녕하세요">
            </div>

            <div class="form-group">
                <label for="translation">영어 번역 <span class="required">*</span></label>
                <input type="text" id="translation" name="translation" required placeholder="Hello">
            </div>

            <div class="form-group">
                <label for="pronunciation">발음 <span class="required">*</span></label>
                <input type="text" id="pronunciation" name="pronunciation" required placeholder="an-nyeong-ha-se-yo">
            </div>

            <div class="form-group">
                <label for="situationContext">상황 설명 <span class="required">*</span></label>
                <textarea id="situationContext" name="situation_context" rows="3" required placeholder="처음 만났을 때 사용하는 인사말입니다."></textarea>
            </div>

            <div class="form-group">
                <label for="vocabulary">주요 어휘 (쉼표로 구분)</label>
                <textarea id="vocabulary" name="vocabulary" rows="2" placeholder="안녕: hello, 하세요: polite ending"></textarea>
                <small class="form-help">예: 단어1: 뜻1, 단어2: 뜻2</small>
            </div>

            <div class="form-group">
                <label for="order">순서</label>
                <input type="number" id="order" name="order" min="1" placeholder="자동 계산됨">
                <small class="form-help">비워두면 자동으로 다음 순서로 추가됩니다.</small>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel">취소</button>
                <button type="submit" class="btn-submit">저장</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/situation-learning.js' %}"></script>
{% endblock %}
